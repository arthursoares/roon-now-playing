# Project Memory

> This file preserves project context across AI assistant sessions.
> Update this file as the project evolves.

## Project Overview

**Name:** `roon-now-playing`
**Type:** Web application (Roon Now Playing display)
**Purpose:** Display now playing information from Roon music server on various devices/screens
**Version:** 1.2.0

### Technology Stack

- **Framework:** Vue 3 (client), Express 5.x (server)
- **Language:** TypeScript 5.x
- **Build System:** Vite (client), tsc (server/shared)
- **Package Manager:** pnpm 10.x (monorepo with workspaces)
- **Testing:** Vitest configured (no tests written yet)
- **Node Version:** 20+ (23.x for development)
- **CI/CD:** GitHub Actions for Docker image publishing

## Project Structure

```
roon-now-playing/
├── packages/
│   ├── client/                # Vue 3 frontend application
│   │   ├── src/
│   │   │   ├── components/    # UI components (NowPlaying, ZonePicker, ProgressBar)
│   │   │   ├── composables/   # Vue composables
│   │   │   │   ├── useWebSocket.ts
│   │   │   │   ├── usePreferences.ts
│   │   │   │   ├── useColorExtraction.ts
│   │   │   │   ├── useBackgroundStyle.ts
│   │   │   │   └── colorUtils.ts
│   │   │   ├── layouts/       # Display layouts (5 layouts)
│   │   │   └── views/         # Page views (NowPlayingView, AdminView)
│   │   └── dist/              # Built client files
│   ├── server/                # Express + WebSocket backend
│   │   └── src/
│   │       ├── index.ts       # Main server entry
│   │       ├── websocket.ts   # WebSocket manager
│   │       ├── admin.ts       # Admin API routes
│   │       └── roon.ts        # Roon API client
│   └── shared/                # Shared types and constants
│       └── src/index.ts       # All shared exports
├── assets/                    # Screenshots for documentation
├── .ai-assistant/             # AI instruction files
├── .github/workflows/         # CI/CD pipelines
└── Dockerfile                 # Multi-stage Docker build
```

## Key Features

### Layouts (5 total)
- **Detailed**: Album art + full track info + progress bar (two-column on wide screens)
- **Minimal**: Full-screen artwork with overlay text (ignores background setting)
- **Fullscreen**: Just the album artwork centered, no text
- **Ambient**: Color-extracted background with artwork and info (10-ft UI)
- **Cover**: Clean album art with crossfade transitions and shadow

### Backgrounds (5 options)
- `black`: Pure black (#000000) - default
- `white`: Pure white (#ffffff)
- `dominant`: Vibrant solid color extracted from artwork
- `gradient-radial`: Radial gradient from center using artwork colors
- `gradient-linear`: Diagonal (135°) linear gradient using artwork colors

### Fonts (7 options)
- `system`, `patua-one`, `comfortaa`, `noto-sans-display`, `coda`, `bellota-text`, `big-shoulders`

### Configurable Options (URL params + Admin UI + localStorage)
- `layout`: Layout type
- `font`: Font family
- `background`: Background style
- `zone`: Zone ID or name to auto-select

### Admin Panel
- Available at `/admin`
- Lists connected clients
- Push settings to clients remotely (layout, font, background, zone)
- Set friendly names for clients

## Architecture Decisions

| Decision | Date | Reasoning |
|----------|------|-----------|
| Monorepo with pnpm workspaces | Initial | Share types between client/server |
| Vue 3 Composition API | Initial | Better TypeScript support, composables pattern |
| Color extraction from artwork | 2025-01 | Dynamic theming for Ambient layout |
| Configurable backgrounds | 2025-01 | Allow per-layout background customization |
| Vibrant gradient generation | 2025-01 | Punchier gradients that preserve original saturation |
| MinimalLayout ignores background | 2025-01 | Artwork covers entire screen, background not visible |

## Key Composables

| Composable | Purpose |
|------------|---------|
| `useColorExtraction` | Extract dominant colors + vibrant gradient from artwork |
| `useBackgroundStyle` | Generate CSS styles for all 5 background types |
| `usePreferences` | Handle URL params, localStorage, and preference persistence |
| `useWebSocket` | WebSocket connection with metadata sync |

## CSS Variables (from useBackgroundStyle)

| Variable | Description |
|----------|-------------|
| `--text-color` | Primary text color |
| `--text-secondary` | Secondary text (80% opacity) |
| `--text-tertiary` | Tertiary text (60% opacity) |
| `--progress-bar-bg` | Progress bar background |
| `--progress-bar-fill` | Progress bar fill |

## Git Workflow

### Branch Naming
- **Main Branch:** `main`
- **Feature Branches:** `feature/description`

### Commit Message Format
Brief description of change (imperative mood)

**Examples:**
- `Add configurable background options for all layouts`
- `Improve gradient vibrancy and fix background-related issues`

## Known Issues & Limitations

| Issue | Impact | Workaround |
|-------|--------|------------|
| No ESLint configured | Linting not available | Manual code review |
| No test suite | No automated testing | Manual testing |

## Session Context

### Recent Work (v1.2.0)
- Implemented configurable backgrounds for all layouts
- Added 5 background types with color extraction
- Created useBackgroundStyle composable
- Added vibrant gradient generation for punchier colors
- Fixed progress bar visibility on light backgrounds
- MinimalLayout ignores background (artwork covers screen)
- Added background selection to Admin UI
- Updated README with contribution guide and screenshots
- Admin UI branding (header with project name, back link, footer)
- Fixed Express 5.x route compatibility

### Files Modified Recently
- `packages/shared/src/index.ts` - Added BackgroundType
- `packages/client/src/composables/useBackgroundStyle.ts` - New
- `packages/client/src/composables/useColorExtraction.ts` - Added vibrantGradient
- `packages/client/src/composables/colorUtils.ts` - Added generateVibrantGradient
- `packages/client/src/layouts/*.vue` - All updated for backgrounds
- `packages/client/src/views/AdminView.vue` - Branding updates
- `packages/server/src/index.ts` - Express 5 route fix
- `README.md` - Screenshots and contribution guide
- `Dockerfile` - pnpm version update
- `assets/` - Example screenshots

## Important Technical Notes

### Express 5.x Route Patterns
Express 5 uses path-to-regexp v8+ which requires **named wildcard parameters**.
- **Wrong:** `app.get('*', ...)` - throws "Missing parameter name" error
- **Correct:** `app.get('*splat', ...)` - named wildcard

### pnpm Lockfile Compatibility
The pnpm lockfile format changed between v8 and v10. When updating pnpm version:
1. Update `Dockerfile` pnpm version
2. Ensure `pnpm-lock.yaml` is committed (format differs between versions)
3. Keep `packageManager` field in `package.json` in sync

### Docker CI/CD
- GitHub Actions workflow at `.github/workflows/docker-publish.yml`
- Builds multi-platform images (amd64, arm64)
- Publishes to `ghcr.io/arthursoares/roon-now-playing`
- Triggered on push to main or version tags (v*)

---

**Last Updated:** 2026-01-27
