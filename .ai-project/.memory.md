# Project Memory: Roon Screen Cover

## Overview

Roon Now Playing Display - A Roon extension that displays real-time album artwork and track metadata on web-connected clients. Designed for "always-on" displays (tablets, wall-mounted screens, TVs).

## Tech Stack

| Layer | Technology |
|-------|------------|
| Runtime | Node.js 20+ |
| Package Manager | pnpm 8+ (workspaces) |
| Backend | Express, ws, node-roon-api (GitHub) |
| Frontend | Vue 3, Vite, TypeScript |
| Testing | Vitest, jsdom |
| Deployment | Docker, docker-compose |

## Architecture

```
┌─────────────────┐         ┌─────────────────────────────────┐
│   Roon Core     │◄───────►│   Extension Server (Node.js)   │
└─────────────────┘  API    │                                 │
                            │  • Roon API client              │
                            │  • WebSocket server (/ws)       │
                            │  • Artwork cache (disk)         │
                            │  • Static file server (SPA)     │
                            └──────────────┬──────────────────┘
                                           │ WebSocket
                                           ▼
                                      ┌─────────┐
                                      │ Clients │
                                      └─────────┘
```

## Project Structure

```
roon-screen-cover/
├── packages/
│   ├── shared/          # Shared TypeScript types
│   │   └── src/index.ts # Zone, Track, NowPlaying, LayoutType, messages
│   ├── server/          # Node.js backend
│   │   └── src/
│   │       ├── index.ts      # Entry: Express + WS server
│   │       ├── roon.ts       # Roon API client + subscriptions
│   │       ├── websocket.ts  # WebSocket connection handling
│   │       ├── artwork.ts    # Artwork cache + proxy
│   │       └── logger.ts     # Basic logging
│   └── client/          # Vue 3 frontend
│       └── src/
│           ├── App.vue
│           ├── components/
│           │   ├── NowPlaying.vue
│           │   ├── ZonePicker.vue
│           │   └── ProgressBar.vue
│           ├── layouts/
│           │   ├── MinimalLayout.vue
│           │   ├── DetailedLayout.vue
│           │   ├── FullscreenLayout.vue
│           │   └── AmbientLayout.vue    # 10-foot UI with color extraction
│           └── composables/
│               ├── useWebSocket.ts
│               ├── useNowPlaying.ts
│               ├── usePreferences.ts
│               ├── useColorExtraction.ts # Dynamic color from artwork
│               └── useFontLoader.ts      # Dynamic Google Font loading
```

## Layout Types

| Layout | Description |
|--------|-------------|
| `detailed` | Artwork, title, artist, album, progress bar (default) |
| `minimal` | Full-bleed artwork with title overlay |
| `fullscreen` | Artwork only (ambient mode) |
| `ambient` | **10-foot UI** - Dynamic colors, two-column, large typography |

## Key Features

### Ambient Layout (10-foot UI)
- **Dynamic color extraction** from album artwork using canvas sampling
- **Adaptive light/dark mode** based on artwork brightness
- **Two-column layout**: 55% artwork, 45% metadata
- **Typography scale**: Artist 48-64px, Title 36-48px, Album 28-36px
- **Safe zones**: 7.5% padding for TV overscan
- **Crossfade transitions** (500ms) between tracks
- **Hue-matched shadows** on artwork

### Color Extraction Algorithm
1. Draw artwork to 50x50 canvas
2. Sample pixels, convert to HSL
3. Group by 12 hue buckets, find dominant
4. If lightness > 50% → light mode, else dark mode
5. Adjust saturation/lightness for background
6. Calculate text color via luminance threshold

## API Endpoints

| Method | Path | Description |
|--------|------|-------------|
| GET | `/api/zones` | List available zones |
| GET | `/api/artwork/:key` | Cached/proxied artwork |
| GET | `/api/health` | Health check |
| WS | `/ws` | Real-time updates |

## WebSocket Messages

**Client → Server:**
- `{ type: "subscribe", zone_id: "..." }`
- `{ type: "unsubscribe" }`

**Server → Client:**
- `{ type: "zones", zones: [...] }`
- `{ type: "now_playing", zone_id, state, track, seek_position }`
- `{ type: "seek", zone_id, seek_position }`

## URL Parameters

- `?zone=<name>` - Auto-select zone by name
- `?layout=<type>` - Set layout (minimal, detailed, fullscreen, ambient)
- `?font=<type>` - Set font (system, patua-one, comfortaa, noto-sans-display, coda, bellota-text, big-shoulders)

## Commands

```bash
pnpm dev          # Development (server + client)
pnpm build        # Production build
pnpm start        # Run production server
pnpm test         # Run tests
pnpm typecheck    # Type checking
```

## Dependencies Note

Roon API packages are installed from GitHub (not npm):
- `node-roon-api`: github:RoonLabs/node-roon-api
- `node-roon-api-transport`: github:RoonLabs/node-roon-api-transport
- `node-roon-api-image`: github:RoonLabs/node-roon-api-image
- `node-roon-api-status`: github:RoonLabs/node-roon-api-status

## Recent Changes

- **2024-01**: Initial implementation with 3 layouts
- **2024-01**: Added ambient layout with dynamic color extraction (10-foot UI)
- **2026-01**: Added Google Fonts support via URL param (`?font=comfortaa`)

---

*Last updated: 2026-01*
